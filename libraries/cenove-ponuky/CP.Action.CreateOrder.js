/**
 * CENOV√â PONUKY - Vytvorenie/Aktualiz√°cia Z√°kazky
 *
 * Typ scriptu: Manual Action (manu√°lne spustenie pou≈æ√≠vateƒæom)
 * Kni≈ænica: Cenov√© ponuky
 *
 * Popis:
 * - Vytvor√≠ alebo aktualizuje z√°znam v kni≈ænici Z√°kazky z cenovej ponuky
 * - Pri CREATE: Vytvor√≠ z√°kazku + v≈°etky diely v Z√°kazky Diely
 * - Pri UPDATE: Sync v≈°etky polia + vytvor√≠ ch√Ωbaj√∫ce diely (existuj√∫ce diely zost√°vaj√∫ bez zmeny)
 * - Prepojenie: Z√°kazky ‚Üí linkToEntry Cenov√© ponuky (vytvor√≠ linksFrom)
 * - Automatick√© generovanie ƒç√≠sla z√°kazky pomocou MementoAutoNumber
 *
 * Verzia: 1.5.0
 * D√°tum: 2025-10-10
 * Autor: ASISTANTO
 *
 * CHANGELOG:
 * v1.5.0 (2025-10-10):
 *   - FIX: Pou≈æit√° link() met√≥da namiesto set() pre materi√°ly a pr√°ce
 *   - Atrib√∫ty sa nastavuj√∫ pomocou setAttr() PO linkovan√≠
 *   - Workflow: orderPart.link(field, entry) ‚Üí entry.setAttr(attr, value)
 *   - Spr√°vny Memento DB API vzor pre linkToEntry s atrib√∫tmi
 *   - Detailn√Ω debug logging pre diagnostiku
 * v1.4.0 (2025-10-10):
 *   - DEBUG: Zmenen√© poradie oper√°ci√≠ (revert v1.5.0)
 *   - Pokus o rie≈°enie cez poradie pripojenia dielu
 * v1.3.2 (2025-10-10):
 *   - DEBUG: Pridan√Ω detailn√Ω logging pre diagnostiku materi√°lov a pr√°c
 *   - Pridan√© v√Ωpisy poƒçtu polo≈æiek, atrib√∫tov a krokov nastavovania
 *   - Pom√¥≈æe identifikova≈• preƒço sa polo≈æky nevytv√°raj√∫ v dieloch z√°kazky
 * v1.3.1 (2025-10-10):
 *   - OPRAVA: Pou≈æit√° spr√°vna met√≥da .attr() namiesto .a() pre ƒç√≠tanie atrib√∫tov
 *   - Fix pre TypeError: Cannot find function a in object [object Entry]
 *   - Opraven√© kop√≠rovanie atrib√∫tov pre materi√°ly a pr√°ce
 *   - Verifikovan√© podƒæa Memento Database Wiki dokument√°cie
 * v1.3.0 (2025-10-10):
 *   - Pridan√° kontrola existencie dielov pri UPDATE re≈æime
 *   - Script teraz vytv√°ra len ch√Ωbaj√∫ce diely (porovnanie podƒæa ƒç√≠sla dielu)
 *   - Existuj√∫ce diely zost√°vaj√∫ nezmenen√©
 *   - Debug info ukazuje poƒçet vytvoren√Ωch aj preskoƒçen√Ωch dielov
 * v1.2.2 (2025-10-10):
 *   - Opraven√° detekcia linksFrom pomocou utils.safeGetLinksFrom()
 *   - Pou≈æit√Ω spr√°vny Memento API vzor: safeGetLinksFrom(entry, "Z√°kazky", "Cenov√° ponuka")
 *   - Odstr√°nen√° komplexn√° logika manu√°lneho parsovania linksFrom
 * v1.2.1 (2025-10-10):
 * - OPRAVA: Vylep≈°en√° detekcia existuj√∫cej z√°kazky cez linksFrom
 * - Porovn√°va ID aj n√°zov kni≈ænice pre spoƒæahlivej≈°iu kontrolu
 * - Pridan√Ω detailn√Ω debug log pre kontrolu prepojen√≠
 * v1.2.0 (2025-10-10):
 * - NOV√â: D√°tum z√°kazky sa nastav√≠ na d√°tum generovania (nie z CP)
 * - NOV√â: D√°tum dielov sa nastav√≠ na d√°tum generovania (nie z CP)
 * - ZMENA: Pole "ƒå√≠slo CP" v dieloch z√°kazky teraz obsahuje ƒç√≠slo z√°kazky (nie CP)
 * - NOV√â: Automatick√© z√≠skanie Klienta z poƒæa Miesto ‚Üí Klient
 * - NOV√â: Kopirovanie atrib√∫tov (mno≈æstvo, cena, cena celkom) pre Materi√°l a Pr√°ce
 * v1.1.3 (2025-10-10):
 * - OPRAVA: Pou≈æitie lib.create({}) s pr√°zdnym objektom namiesto lib.create()
 * - FIX: NullPointerException pri vytv√°ran√≠ z√°kazky - potrebn√Ω pr√°zdny objekt ako parameter
 * - Aplikovan√© na ordersLib.create({}) aj orderPartsLib.create({})
 * v1.1.2 (2025-10-10):
 * - OPRAVA: Pridan√° kontrola ƒçi sa z√°kazka vytvorila
 * - DIAGNOSTIKA: Jasn√° chybov√° hl√°≈°ka ak Manual Action nem√¥≈æe vytv√°ra≈• z√°znamy
 * - N√°vrh rie≈°enia: Pou≈æi≈• Trigger script namiesto Manual Action
 * v1.1.1 (2025-10-10):
 * - OPRAVA: MementoConfig.getConfig() namiesto priameho pr√≠stupu
 * - FIX: "Cannot read property quote of undefined" - pou≈æit√Ω getConfig()
 * v1.1.0 (2025-10-10):
 * - PRIDAN√â: Automatick√© generovanie ƒç√≠sla z√°kazky pomocou MementoAutoNumber
 * - Pou≈æ√≠va "Z Placeholder" z ASISTANTO Defaults (form√°t: ZYYXXX)
 * - Fallback: Ak MementoAutoNumber nie je dostupn√Ω, pou≈æije ƒç√≠slo z cenovej ponuky
 * - Detailn√Ω debug log pre generovanie ƒç√≠sla
 * v1.0.0 (2025-10-10):
 * - Vytvoren√Ω script pre tvorbu z√°kaziek z cenov√Ωch pon√∫k
 * - Implementovan√° CREATE logika (z√°kazka + diely)
 * - Implementovan√° UPDATE logika (len polia z√°kazky)
 * - Mapovanie pol√≠ podƒæa CP.Action.CreateOrder.MAPPING.js
 */

// ==============================================
// INICIALIZ√ÅCIA
// ==============================================

var lib = lib();
var currentEntry = entry();
var utils = MementoUtils;
var centralConfig = MementoConfig.getConfig(); // Z√≠skaj CONFIG objekt

// ==============================================
// SKRIPT START
// ==============================================

try {
    utils.clearLogs(currentEntry);
    utils.addDebug(currentEntry, "   VYTVORENIE/AKTUALIZ√ÅCIA Z√ÅKAZKY Z CENOVEJ PONUKY   ");
    utils.addDebug(currentEntry, "");

    // Z√≠skaj konfiguraƒçn√© polia
    var fields = centralConfig.fields.quote;
    var orderFields = centralConfig.fields.order;
    var quotePartFields = centralConfig.fields.quotePart;
    var orderPartFields = centralConfig.fields.orderPart;
    var commonFields = centralConfig.fields.common;

    // Z√≠skaj kni≈ænice
    var ordersLib = libByName("Z√°kazky");
    var orderPartsLib = libByName("Z√°kazky Diely");

    if (!ordersLib) {
        throw new Error("Kni≈ænica 'Z√°kazky' nebola n√°jden√°");
    }
    if (!orderPartsLib) {
        throw new Error("Kni≈ænica 'Z√°kazky Diely' nebola n√°jden√°");
    }

    // ==============================================
    // KROK 1: KONTROLA EXISTENCIE Z√ÅKAZKY
    // ==============================================

    utils.addDebug(currentEntry, "üìã KROK 1: Kontrola existencie z√°kazky");
    utils.addDebug(currentEntry, "");

    // Zisti ƒç√≠slo cenovej ponuky
    var quoteNumber = utils.safeGet(currentEntry, fields.number) || "";
    var quoteName = utils.safeGet(currentEntry, fields.name) || "";

    utils.addDebug(currentEntry, "  Cenov√° ponuka:");
    utils.addDebug(currentEntry, "    ƒå√≠slo: " + quoteNumber);
    utils.addDebug(currentEntry, "    N√°zov: " + quoteName);
    utils.addDebug(currentEntry, "");

    // N√°jdi existuj√∫cu z√°kazku cez linksFrom (Z√°kazky -> Cenov√° ponuka)
    var existingOrders = utils.safeGetLinksFrom(currentEntry, "Z√°kazky", "Cenov√° ponuka");

    utils.addDebug(currentEntry, "  üîç Kontrolujem linksFrom zo Z√°kaziek: " + existingOrders.length + " n√°jden√Ωch");

    var orderExists = existingOrders.length > 0;
    var order = orderExists ? existingOrders[0] : null;
    var mode = orderExists ? "UPDATE" : "CREATE";

    utils.addDebug(currentEntry, "");
    utils.addDebug(currentEntry, "  üìä Poƒçet n√°jden√Ωch z√°kaziek: " + existingOrders.length);

    utils.addDebug(currentEntry, "  Re≈æim: " + mode);
    if (orderExists) {
        var orderNumber = utils.safeGet(order, orderFields.number) || "";
        var orderName = utils.safeGet(order, orderFields.name) || "";
        utils.addDebug(currentEntry, "  ‚úÖ Existuj√∫ca z√°kazka:");
        utils.addDebug(currentEntry, "    ƒå√≠slo: " + orderNumber);
        utils.addDebug(currentEntry, "    N√°zov: " + orderName);
    } else {
        utils.addDebug(currentEntry, "  ‚ÑπÔ∏è Z√°kazka neexistuje, bude vytvoren√° nov√°");
    }
    utils.addDebug(currentEntry, "");

    // ==============================================
    // KROK 2: PR√çPRAVA D√ÅT PRE SYNCHRONIZ√ÅCIU
    // ==============================================

    utils.addDebug(currentEntry, "üì¶ KROK 2: Pr√≠prava d√°t pre synchroniz√°ciu");
    utils.addDebug(currentEntry, "");

    var syncData = {};

    // === Z√ÅKLADN√â IDENTIFIKAƒåN√â POLIA ===
    syncData[orderFields.number] = utils.safeGet(currentEntry, fields.number);
    syncData[orderFields.name] = utils.safeGet(currentEntry, fields.name);
    syncData[orderFields.description] = utils.safeGet(currentEntry, fields.description); // Popis cenovej ponuky ‚Üí Popis z√°kazky
    // D√°tum bude nastaven√Ω na d√°tum generovania (nie z cenovej ponuky)
    syncData[orderFields.date] = new Date();

    // Typ cenovej ponuky ‚Üí Typ z√°kazky
    syncData[orderFields.orderCalculationType] = utils.safeGet(currentEntry, fields.type);

    // Miesto realiz√°cie ‚Üí Miesto
    syncData[orderFields.place] = utils.safeGetLinks(currentEntry, fields.place);

    // === KLIENT Z MIESTA ===
    // Zisti klienta z poƒæa Miesto -> Klient
    var placeEntries = utils.safeGetLinks(currentEntry, fields.place);
    if (placeEntries && placeEntries.length > 0) {
        var placeEntry = placeEntries[0];
        var clientEntries = utils.safeGetLinks(placeEntry, centralConfig.fields.place.customer);
        if (clientEntries && clientEntries.length > 0) {
            syncData[orderFields.client] = clientEntries;
            utils.addDebug(currentEntry, "  ‚ÑπÔ∏è Klient z√≠skan√Ω z miesta: " + utils.safeGet(clientEntries[0], centralConfig.fields.client.name || "N√°zov"));
        }
    }

    utils.addDebug(currentEntry, "  ‚úÖ Z√°kladn√© polia pripraven√©");

    // === √öƒåTOVANIE DOPRAVY ===
    syncData[orderFields.rideCalculation] = utils.safeGet(currentEntry, fields.rideCalculation);
    syncData[orderFields.transportPercentage] = utils.safeGet(currentEntry, fields.ridePercentage);
    syncData[orderFields.kmPrice] = utils.safeGetLinks(currentEntry, fields.kmPrice);
    syncData[orderFields.rideFlatRate] = utils.safeGetLinks(currentEntry, fields.rideFlatRate);
    syncData[orderFields.fixedTransportPrice] = utils.safeGet(currentEntry, fields.fixedTransportPrice);

    utils.addDebug(currentEntry, "  ‚úÖ Doprava pripraven√°");

    // === √öƒåTOVANIE PRESUNU HM√îT ===
    syncData[orderFields.massTransferCalculation] = utils.safeGet(currentEntry, fields.massTransferCalculation);
    syncData[orderFields.massTransferPercentage] = utils.safeGet(currentEntry, fields.massTransferPercentage);
    syncData[orderFields.massTransferPrice] = utils.safeGetLinks(currentEntry, fields.massTransferPriceEntry); // Cena presunu hm√¥t materi√°lu
    syncData[orderFields.massTransferFlatRate] = utils.safeGetLinks(currentEntry, fields.massTransferFlatRate);
    syncData[orderFields.fixedMassTransferPrice] = utils.safeGet(currentEntry, fields.fixedMassTransferPrice);
    syncData[orderFields.materialWeight] = utils.safeGet(currentEntry, fields.materialWeight);

    utils.addDebug(currentEntry, "  ‚úÖ Presun hm√¥t pripraven√Ω");

    // === √öƒåTOVANIE SUBDOD√ÅVOK ===
    syncData[orderFields.subcontractsCalculation] = utils.safeGet(currentEntry, fields.subcontractsCalculation);
    syncData[orderFields.subcontractorMarkup] = utils.safeGet(currentEntry, fields.subcontractsPercentage); // Subdod√°vky % ‚Üí Prir√°≈æka subdod√°vky

    utils.addDebug(currentEntry, "  ‚úÖ Subdod√°vky pripraven√©");

    // === DPH ===
    syncData[orderFields.vatRate] = utils.safeGet(currentEntry, fields.vatRate);

    utils.addDebug(currentEntry, "  ‚úÖ DPH pripraven√©");
    utils.addDebug(currentEntry, "");

    // ==============================================
    // KROK 3: VYTVORENIE ALEBO AKTUALIZ√ÅCIA Z√ÅKAZKY
    // ==============================================

    utils.addDebug(currentEntry, "üîß KROK 3: " + (orderExists ? "Aktualiz√°cia" : "Vytvorenie") + " z√°kazky");
    utils.addDebug(currentEntry, "");

    if (!orderExists) {
        // === CREATE MODE ===
        utils.addDebug(currentEntry, "  üÜï Vytv√°ram nov√∫ z√°kazku...");

        // Vytvor z√°znam s pr√°zdnym objektom
        order = ordersLib.create({});

        // Kontrola ƒçi sa z√°kazka vytvorila
        if (!order) {
            throw new Error("Nepodarilo sa vytvori≈• z√°znam v kni≈ænici Z√°kazky. Skontroluj opr√°vnenia a ƒçi kni≈ænica existuje.");
        }

        utils.addDebug(currentEntry, "  ‚úÖ Nov√Ω z√°znam vytvoren√Ω v kni≈ænici Z√°kazky");

        // === GENEROVANIE ƒå√çSLA Z√ÅKAZKY ===
        utils.addDebug(currentEntry, "  üî¢ Generujem ƒç√≠slo z√°kazky...");

        // Pou≈æitie MementoAutoNumber pre generovanie ƒç√≠sla
        var orderNumber = "";
        try {
            if (typeof MementoAutoNumber !== 'undefined' && MementoAutoNumber.isLoaded && MementoAutoNumber.isLoaded()) {
                var numberResult = MementoAutoNumber.generateNumber(
                    "Z√°kazky",
                    "ƒå√≠slo",
                    "Z Placeholder"
                );

                if (numberResult.success) {
                    orderNumber = numberResult.number;
                    utils.addDebug(currentEntry, "    ‚úÖ Vygenerovan√© ƒç√≠slo: " + orderNumber);
                } else {
                    utils.addDebug(currentEntry, "    ‚ö†Ô∏è Chyba pri generovan√≠ ƒç√≠sla: " + numberResult.error);
                    utils.addDebug(currentEntry, "    ‚ÑπÔ∏è Pou≈æije sa ƒç√≠slo z cenovej ponuky");
                    orderNumber = quoteNumber;
                }
            } else {
                utils.addDebug(currentEntry, "    ‚ÑπÔ∏è MementoAutoNumber nie je dostupn√Ω");
                utils.addDebug(currentEntry, "    ‚ÑπÔ∏è Pou≈æije sa ƒç√≠slo z cenovej ponuky");
                orderNumber = quoteNumber;
            }
        } catch (e) {
            utils.addDebug(currentEntry, "    ‚ö†Ô∏è Chyba pri volan√≠ MementoAutoNumber: " + e.toString());
            utils.addDebug(currentEntry, "    ‚ÑπÔ∏è Pou≈æije sa ƒç√≠slo z cenovej ponuky");
            orderNumber = quoteNumber;
        }

        // Nastav ƒç√≠slo z√°kazky
        syncData[orderFields.number] = orderNumber;
        utils.addDebug(currentEntry, "");

        // Nastav v≈°etky polia
        for (var fieldName in syncData) {
            if (syncData.hasOwnProperty(fieldName)) {
                var value = syncData[fieldName];
                if (value !== null && value !== undefined) {
                    try {
                        order.set(fieldName, value);
                    } catch (e) {
                        utils.addDebug(currentEntry, "  ‚ö†Ô∏è Chyba pri nastaven√≠ poƒæa '" + fieldName + "': " + e.toString());
                    }
                }
            }
        }

        // Vytvor linkToEntry: Z√°kazka ‚Üí Cenov√° ponuka
        order.set(orderFields.quote, [currentEntry]);

        utils.addDebug(currentEntry, "  ‚úÖ Z√°kazka vytvoren√°");
        utils.addDebug(currentEntry, "    ƒå√≠slo: " + utils.safeGet(order, orderFields.number));
        utils.addDebug(currentEntry, "    N√°zov: " + utils.safeGet(order, orderFields.name));
        utils.addDebug(currentEntry, "");

    } else {
        // === UPDATE MODE ===
        utils.addDebug(currentEntry, "  üîÑ Aktualizujem existuj√∫cu z√°kazku...");

        // Aktualizuj v≈°etky polia OKREM ƒç√≠sla z√°kazky (ƒç√≠slo sa nemen√≠ pri update)
        for (var fieldName in syncData) {
            if (syncData.hasOwnProperty(fieldName)) {
                // Preskoƒçi≈• ƒç√≠slo z√°kazky - to sa nemen√≠ pri aktualiz√°cii
                if (fieldName === orderFields.number) {
                    continue;
                }

                var value = syncData[fieldName];
                if (value !== null && value !== undefined) {
                    try {
                        order.set(fieldName, value);
                    } catch (e) {
                        utils.addDebug(currentEntry, "  ‚ö†Ô∏è Chyba pri aktualiz√°cii poƒæa '" + fieldName + "': " + e.toString());
                    }
                }
            }
        }

        utils.addDebug(currentEntry, "  ‚úÖ Z√°kazka aktualizovan√°");
        utils.addDebug(currentEntry, "    ƒå√≠slo: " + utils.safeGet(order, orderFields.number));
        utils.addDebug(currentEntry, "    N√°zov: " + utils.safeGet(order, orderFields.name));
        utils.addDebug(currentEntry, "");
    }

    // ==============================================
    // KROK 4: VYTVORENIE/AKTUALIZ√ÅCIA DIELOV
    // ==============================================

    utils.addDebug(currentEntry, "üìã KROK 4: " + (orderExists ? "Kontrola a vytvorenie ch√Ωbaj√∫cich dielov" : "Vytvorenie dielov z√°kazky"));
    utils.addDebug(currentEntry, "");

    // Z√≠skaj diely z cenovej ponuky
    var quoteParts = utils.safeGetLinks(currentEntry, fields.parts) || [];
    utils.addDebug(currentEntry, "  Poƒçet dielov v cenovej ponuke: " + quoteParts.length);

    // Pri UPDATE: Z√≠skaj existuj√∫ce diely z√°kazky
    var existingOrderParts = [];
    var existingPartNumbers = [];
    if (orderExists) {
        existingOrderParts = utils.safeGetLinks(order, orderFields.parts) || [];
        utils.addDebug(currentEntry, "  Poƒçet existuj√∫cich dielov v z√°kazke: " + existingOrderParts.length);

        // Vytvor mapu existuj√∫cich ƒç√≠sel dielov
        for (var ep = 0; ep < existingOrderParts.length; ep++) {
            var existingPartNumber = utils.safeGet(existingOrderParts[ep], orderPartFields.number);
            if (existingPartNumber) {
                existingPartNumbers.push(existingPartNumber);
            }
        }
        utils.addDebug(currentEntry, "  Existuj√∫ce ƒç√≠sla dielov: " + existingPartNumbers.join(", "));
    }
    utils.addDebug(currentEntry, "");

    if (quoteParts.length === 0) {
        utils.addDebug(currentEntry, "  ‚ÑπÔ∏è Cenov√° ponuka nem√° ≈æiadne diely");
    } else {
        var createdPartsCount = 0;
        var skippedPartsCount = 0;
        var generatedOrderNumber = utils.safeGet(order, orderFields.number) || quoteNumber; // ƒå√≠slo vygenerovanej z√°kazky
        var creationDate = new Date(); // D√°tum generovania

        for (var i = 0; i < quoteParts.length; i++) {
            var quotePart = quoteParts[i];

            try {
                var partNumber = utils.safeGet(quotePart, quotePartFields.number);
                var partType = utils.safeGet(quotePart, quotePartFields.partType) || ("Diel #" + (i + 1));
                var partName = utils.safeGet(quotePart, quotePartFields.name) || "";

                // Pri UPDATE: Skontroluj ƒçi diel u≈æ existuje
                if (orderExists && partNumber && existingPartNumbers.indexOf(partNumber) !== -1) {
                    utils.addDebug(currentEntry, "  ‚è≠Ô∏è Diel " + (i + 1) + "/" + quoteParts.length + " (ƒç√≠slo " + partNumber + ") u≈æ existuje - preskakujem");
                    skippedPartsCount++;
                    continue;
                }

                utils.addDebug(currentEntry, "  üîß Vytv√°ram diel " + (i + 1) + "/" + quoteParts.length + ":");
                utils.addDebug(currentEntry, "    ƒå√≠slo: " + partNumber);
                utils.addDebug(currentEntry, "    Typ: " + partType);
                utils.addDebug(currentEntry, "    N√°zov: " + partName);

                // Vytvor nov√Ω diel v Z√°kazky Diely
                var orderPart = orderPartsLib.create({});

                    // === Z√ÅKLADN√â POLIA ===
                    orderPart.set(orderPartFields.number, utils.safeGet(quotePart, quotePartFields.number));
                    orderPart.set(orderPartFields.date, creationDate); // D√°tum generovania z√°kazky
                    orderPart.set(orderPartFields.orderNumber, generatedOrderNumber); // ƒå√≠slo z√°kazky
                    orderPart.set(orderPartFields.name, partName);
                    orderPart.set(orderPartFields.partType, partType);
                    orderPart.set(orderPartFields.note, utils.safeGet(quotePart, quotePartFields.note));

                    // === CENOV√â POLIA ===
                    orderPart.set(orderPartFields.materialSum, utils.safeGet(quotePart, quotePartFields.materialSum));
                    orderPart.set(orderPartFields.workSum, utils.safeGet(quotePart, quotePartFields.workSum));
                    orderPart.set(orderPartFields.totalSum, utils.safeGet(quotePart, quotePartFields.totalSum));

                    // === POLO≈ΩKY S ATRIB√öTMI - Preƒç√≠taj atrib√∫ty najprv ===
                    var materials = utils.safeGetLinks(quotePart, quotePartFields.materials);
                    var works = utils.safeGetLinks(quotePart, quotePartFields.works);

                    utils.addDebug(currentEntry, "    üîç DEBUG - Materi√°ly z CP: " + (materials ? materials.length : 0));
                    utils.addDebug(currentEntry, "    üîç DEBUG - Pr√°ce z CP: " + (works ? works.length : 0));

                    // KROK 1: Preƒç√≠taj V≈†ETKY atrib√∫ty PRED linkovan√≠m
                    var materialsData = [];
                    if (materials && materials.length > 0) {
                        for (var m = 0; m < materials.length; m++) {
                            var mat = materials[m];
                            materialsData.push({
                                entry: mat,
                                qty: mat.attr("mno≈æstvo") || 0,
                                price: mat.attr("cena") || 0,
                                total: mat.attr("cena celkom") || 0,
                                name: utils.safeGet(mat, "N√°zov") || ("Materi√°l #" + (m + 1))
                            });
                        }
                        utils.addDebug(currentEntry, "    üìñ Preƒç√≠tan√© atrib√∫ty materi√°lov: " + materialsData.length);
                    }

                    var worksData = [];
                    if (works && works.length > 0) {
                        for (var w = 0; w < works.length; w++) {
                            var wrk = works[w];
                            worksData.push({
                                entry: wrk,
                                qty: wrk.attr("mno≈æstvo") || 0,
                                price: wrk.attr("cena") || 0,
                                total: wrk.attr("cena celkom") || 0,
                                name: utils.safeGet(wrk, "N√°zov") || ("Pr√°ca #" + (w + 1))
                            });
                        }
                        utils.addDebug(currentEntry, "    üìñ Preƒç√≠tan√© atrib√∫ty pr√°c: " + worksData.length);
                    }

                    // KROK 2: Linkni polo≈æky a IHNEƒé nastav atrib√∫ty (v jednom cykle)
                    if (materialsData.length > 0) {
                        utils.addDebug(currentEntry, "    üì¶ Linkujem materi√°ly a nastavujem atrib√∫ty...");
                        for (var m = 0; m < materialsData.length; m++) {
                            var matData = materialsData[m];

                            // Linkni
                            orderPart.link(orderPartFields.materials, matData.entry);

                            // IHNEƒé po linknut√≠ z√≠skaj pole a nastav atrib√∫ty na poslednom prvku
                            var currentMaterials = orderPart.field(orderPartFields.materials);
                            var justLinkedMat = currentMaterials[currentMaterials.length - 1];

                            if (justLinkedMat) {
                                justLinkedMat.setAttr("mno≈æstvo", matData.qty);
                                justLinkedMat.setAttr("cena", matData.price);
                                justLinkedMat.setAttr("cena celkom", matData.total);
                                utils.addDebug(currentEntry, "      ‚úÖ [" + m + "] " + matData.name + ": m=" + matData.qty + ", c=" + matData.price + "‚Ç¨");
                            } else {
                                utils.addDebug(currentEntry, "      ‚ùå [" + m + "] Nie je mo≈æn√© z√≠ska≈• linknut√Ω materi√°l!");
                            }
                        }
                    }

                    if (worksData.length > 0) {
                        utils.addDebug(currentEntry, "    üîß Linkujem pr√°ce a nastavujem atrib√∫ty...");
                        for (var w = 0; w < worksData.length; w++) {
                            var wrkData = worksData[w];

                            // Linkni
                            orderPart.link(orderPartFields.works, wrkData.entry);

                            // IHNEƒé po linknut√≠ z√≠skaj pole a nastav atrib√∫ty na poslednom prvku
                            var currentWorks = orderPart.field(orderPartFields.works);
                            var justLinkedWrk = currentWorks[currentWorks.length - 1];

                            if (justLinkedWrk) {
                                justLinkedWrk.setAttr("mno≈æstvo", wrkData.qty);
                                justLinkedWrk.setAttr("cena", wrkData.price);
                                justLinkedWrk.setAttr("cena celkom", wrkData.total);
                                utils.addDebug(currentEntry, "      ‚úÖ [" + w + "] " + wrkData.name + ": h=" + wrkData.qty + ", c=" + wrkData.price + "‚Ç¨");
                            } else {
                                utils.addDebug(currentEntry, "      ‚ùå [" + w + "] Nie je mo≈æn√© z√≠ska≈• linknut√∫ pr√°cu!");
                            }
                        }
                    }

                    utils.addDebug(currentEntry, "    Materi√°ly: " + materialsData.length);
                    utils.addDebug(currentEntry, "    Pr√°ce: " + worksData.length);
                    utils.addDebug(currentEntry, "    Celkom: " + (utils.safeGet(quotePart, quotePartFields.totalSum) || 0).toFixed(2) + " ‚Ç¨");

                    // KROK 4: Pripoj diel k z√°kazke
                    var existingParts = utils.safeGetLinks(order, orderFields.parts) || [];
                    existingParts.push(orderPart);
                    order.set(orderFields.parts, existingParts);

                    utils.addDebug(currentEntry, "    ‚úÖ Diel pripojen√Ω k z√°kazke");

                    createdPartsCount++;
                    utils.addDebug(currentEntry, "    ‚úÖ Diel vytvoren√Ω a pripojen√Ω");

                } catch (e) {
                    var errorMsg = "Chyba pri vytv√°ran√≠ dielu " + (i + 1) + ": " + e.toString();
                    if (e.lineNumber) errorMsg += ", Line: " + e.lineNumber;
                    utils.addError(currentEntry, errorMsg, "createOrderPart", e);
                    utils.addDebug(currentEntry, "    ‚ùå " + errorMsg);
                }

                utils.addDebug(currentEntry, "");
            }

            utils.addDebug(currentEntry, "  üìä Vytvoren√© diely: " + createdPartsCount + " / " + quoteParts.length);
            if (orderExists && skippedPartsCount > 0) {
                utils.addDebug(currentEntry, "  üìä Preskoƒçen√© existuj√∫ce diely: " + skippedPartsCount);
            }
        }

    // ==============================================
    // V√ùSLEDOK
    // ==============================================

    if (!orderExists) {
        utils.addDebug(currentEntry, "         ‚úÖ Z√ÅKAZKA √öSPE≈†NE VYTVOREN√Å                  ");
        utils.addDebug(currentEntry, "");
        utils.addDebug(currentEntry, "Z√°kazka: " + utils.safeGet(order, orderFields.number) + " - " + utils.safeGet(order, orderFields.name));
        utils.addDebug(currentEntry, "Poƒçet dielov: " + (quoteParts ? quoteParts.length : 0));

        message("‚úÖ Z√°kazka vytvoren√°\n" +
                "ƒå√≠slo: " + utils.safeGet(order, orderFields.number) + "\n" +
                "Poƒçet dielov: " + (quoteParts ? quoteParts.length : 0));
    } else {
        utils.addDebug(currentEntry, "         ‚úÖ Z√ÅKAZKA √öSPE≈†NE AKTUALIZOVAN√Å              ");
        utils.addDebug(currentEntry, "");
        utils.addDebug(currentEntry, "Z√°kazka: " + utils.safeGet(order, orderFields.number) + " - " + utils.safeGet(order, orderFields.name));
        utils.addDebug(currentEntry, "Aktualizovan√© polia: V≈°etky");
        if (quoteParts && quoteParts.length > 0) {
            utils.addDebug(currentEntry, "Vytvoren√© nov√© diely: " + (createdPartsCount || 0) + " / " + quoteParts.length);
            if (skippedPartsCount > 0) {
                utils.addDebug(currentEntry, "Preskoƒçen√© existuj√∫ce: " + skippedPartsCount);
            }
        }

        var messageText = "‚úÖ Z√°kazka aktualizovan√°\n" +
                "ƒå√≠slo: " + utils.safeGet(order, orderFields.number) + "\n" +
                "Aktualizovan√©: V≈°etky polia";
        if (quoteParts && quoteParts.length > 0) {
            messageText += "\nNov√© diely: " + (createdPartsCount || 0) + " / " + quoteParts.length;
        }
        message(messageText);
    }

} catch (error) {
    var errorMsg = "‚ùå KRITICK√Å CHYBA: " + error.toString();
    if (error.lineNumber) errorMsg += ", Line: " + error.lineNumber;
    if (error.stack) errorMsg += "\nStack: " + error.stack;

    utils.addError(currentEntry, errorMsg, "CP.Action.CreateOrder", error);

    utils.addDebug(currentEntry, "");
    utils.addDebug(currentEntry, "         ‚ùå CHYBA PRI VYTV√ÅRAN√ç/AKTUALIZ√ÅCII           ");
    utils.addDebug(currentEntry, "");
    utils.addDebug(currentEntry, errorMsg);

    message("‚ùå Chyba pri vytv√°ran√≠/aktualiz√°cii z√°kazky\n" + error.toString());
}
