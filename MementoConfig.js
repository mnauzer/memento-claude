// ==============================================
// MEMENTOCONFIG - Centralizovan√° konfigur√°cia
// Verzia: 1.0 | D√°tum: August 2025 | Autor: ASISTANTO
// ==============================================
// üìã √öƒåEL:
//    - Centr√°lne miesto pre v≈°etky konfigur√°cie
//    - Jednotn√© n√°zvy kni≈æn√≠c a field mappings
//    - Podpora pre module-specific nastavenia
//    - Backward compatibility s existuj√∫cimi modulmi
// ==============================================

var MementoConfig = (function() {
    'use strict';
    
    // ==============================================
    // PRIVATE VARIABLES
    // ==============================================
    
    var initialized = false;
    var configCache = {};
    var overrides = {};
    
    // ==============================================
    // SYSTEM CONFIGURATION
    // ==============================================
    
    var SYSTEM = {
        version: "1.0",
        environment: "production",
        debug: false,
        configVersion: "2025.08.20",
        
        // Glob√°lne nastavenia
        defaults: {
            timezone: "Europe/Bratislava",
            locale: "sk-SK",
            fiscalYearStart: 1 // Janu√°r
        }
    };
    
    // ==============================================
    // CENTRALIZED LIBRARY NAMES
    // ==============================================
    
    var LIBRARIES = {
        // Core system libraries
        core: {
            defaults: "ASISTANTO Defaults",
            api: "ASISTANTO API",
            notifications: "Notifications",
            settings: "Nastavenia"
        },
        
        // Telegram integration
        telegram: {
            groups: "Telegram Groups",
            bots: "Telegram Bots",
            templates: "Telegram Templates"
        },
        
        // Business entities
        business: {
            employees: "Zamestnanci",
            attendance: "Doch√°dzka",
            workRecords: "Z√°znam pr√°c",
            vehicles: "Kniha j√°zd",
            obligations: "Z√°v√§zky",
            salaries: "sadzby zamestnancov",
            inventory: "Sklad",
            equipment: "Mechaniz√°cia"
        },
        
        // External entities
        external: {
            clients: "Klienti",
            partners: "Partneri",
            orders: "Z√°kazky",
            invoices: "Vy√∫ƒçtovania",
            quotes: "Cenov√© ponuky"
        },
        
        // System libraries
        system: {
            logs: "System Logs",
            audit: "Audit Trail",
            backups: "Z√°lohy",
            migrations: "Migr√°cie"
        }
    };
    
    // ==============================================
    // CENTRALIZED FIELD MAPPINGS
    // ==============================================
    
    var FIELD_MAPPINGS = {
        // Doch√°dzka fields
        attendance: {
            // Main fields
            employees: "Zamestnanci",
            date: "D√°tum",
            arrival: "Pr√≠chod",
            departure: "Odchod",
            workingHours: "Pracovn√° doba",
            employeeCount: "Poƒçet pracovn√≠kov",
            totalWorked: "Odpracovan√©",
            wageCosts: "Mzdov√© n√°klady",
            note: "Pozn√°mka",
            id: "ID",
            notifications: "Notifik√°cie",
            
            // System fields
            info: "info",
            debugLog: "Debug_Log",
            errorLog: "Error_Log",
            view: "view",
            
            // Attributes
            attributes: {
                worked: "odpracovan√©",
                hourlyRate: "hodinovka",
                bonus: "+pr√≠platok (‚Ç¨/h)",
                premium: "+pr√©mia (‚Ç¨)",
                penalty: "-pokuta (‚Ç¨)",
                dailyWage: "denn√° mzda",
                note: "pozn√°mka"
            }
        },
        
        // Notifications fields
        notifications: {
            // Main fields
            type: "Typ spr√°vy",
            source: "Zdroj spr√°vy",
            subject: "Predmet",
            message: "Spr√°va",
            attachment: "Pr√≠loha",
            formatting: "Form√°tovanie",
            status: "Status",
            priority: "Priorita",
            addressee: "Adres√°t",
            
            // Target fields
            groupTopic: "Skupina/T√©ma",
            employee: "Zamestnanec",
            client: "Klient",
            partner: "Partner",
            order: "Z√°kazka",
            
            // Timing fields
            sendAt: "Posla≈• o",
            expireAt: "Vypr≈°a≈• o",
            repeat: "Opakova≈•",
            created: "Vytvoren√©",
            creator: "Vytvoril",
            
            // Telegram specific
            telegramId: "Telegram ID",
            chatId: "Chat ID",
            threadId: "Thread ID",
            messageId: "Message ID",
            messageUrl: "Message URL",
            
            // Response tracking
            sentAt: "Odoslan√© o",
            retryCount: "Pokusov o odoslanie",
            lastError: "Posledn√° chyba",
            responseData: "Response Data",
            
            // Metadata
            sourceLibrary: "Zdrojov√° kni≈ænica",
            sourceId: "Zdrojov√Ω ID"
        },
        
        // Employee fields
        employees: {
            // Personal info
            nick: "Nick",
            firstName: "Meno",
            lastName: "Priezvisko",
            title: "Titul",
            
            // Contact
            email: "Email",
            phone: "Telef√≥n",
            address: "Adresa",
            
            // Work info
            position: "Poz√≠cia",
            department: "Oddelenie",
            supervisor: "Nadriaden√Ω",
            startDate: "D√°tum n√°stupu",
            
            // Telegram
            telegramEnabled: "Telegram povolen√Ω",
            telegramId: "Telegram ID",
            telegramUsername: "Telegram Username",
            
            // System
            active: "Akt√≠vny",
            id: "ID"
        },
        
        // Telegram Groups fields
        telegramGroups: {
            // Basic info
            groupName: "N√°zov skupiny",
            groupType: "Typ skupiny",
            description: "Popis skupiny",
            
            // Telegram data
            chatId: "Chat ID",
            threadId: "Thread ID",
            threadName: "N√°zov t√©my",
            hasThread: "M√° t√©mu",
            
            // Settings
            notificationsEnabled: "Povoli≈• notifik√°cie",
            workingHoursFrom: "Pracovn√Ω ƒças od",
            workingHoursTo: "Pracovn√Ω ƒças do",
            weekendEnabled: "V√≠kend povolen√Ω",
            dailyLimit: "Denn√Ω limit spr√°v",
            sentToday: "Poƒçet spr√°v dnes",
            silentMode: "Tich√° spr√°va",
            priority: "Priorita spr√°v",
            
            // Statistics
            totalMessages: "Celkov√Ω poƒçet spr√°v",
            lastMessage: "Posledn√° spr√°va",
            lastMessageId: "Posledn√© Message ID",
            lastError: "Posledn√° chyba"
        }
    };
    
    // ==============================================
    // CENTRALIZED FORMATS
    // ==============================================
    
    var FORMATS = {
        date: {
            default: "DD.MM.YYYY",
            short: "D.M.YYYY",
            long: "DD. MMMM YYYY",
            iso: "YYYY-MM-DD"
        },
        time: {
            default: "HH:mm",
            seconds: "HH:mm:ss",
            short: "H:mm"
        },
        datetime: {
            default: "DD.MM.YYYY HH:mm",
            long: "DD.MM.YYYY HH:mm:ss",
            iso: "YYYY-MM-DDTHH:mm:ss"
        },
        currency: {
            symbol: "‚Ç¨",
            decimals: 2,
            thousandsSeparator: " ",
            decimalSeparator: ","
        }
    };
    
    // ==============================================
    // MODULE DEFAULT CONFIGURATIONS
    // ==============================================
    
    var MODULE_DEFAULTS = {
        // MementoCore defaults
        core: {
            debug: true,
            includeLineNumbers: true,
            includeStackTrace: false,
            logRetentionDays: 30,
            maxLogSize: 1000 // lines
        },
        
        // MementoAI defaults
        ai: {
            defaultProvider: "OpenAI",
            timeout: 30000,
            maxRetries: 3,
            cacheTimeout: 3600000, // 1 hour
            
            providers: {
                openai: {
                    model: "gpt-4o-mini",
                    temperature: 0.7,
                    maxTokens: 2000
                },
                perplexity: {
                    model: "llama-3.1-sonar-small-128k-online",
                    temperature: 0.7
                }
            }
        },
        
        // MementoTelegram defaults
        telegram: {
            rateLimitDelay: 1000, // 1 second
            maxMessageLength: 4096,
            maxRetries: 3,
            retryDelays: [1000, 3000, 8000],
            defaultParseMode: "HTML",
            
            api: {
                baseUrl: "https://api.telegram.org/bot",
                timeout: 30000
            }
        },
        
        // MementoBusiness defaults
        business: {
            workHoursPerDay: 8,
            overtimeThreshold: 8,
            weekendMultiplier: 1.5,
            holidayMultiplier: 2.0,
            nightShiftBonus: 0.25,
            
            roundToQuarterHour: true,
            quarterHourMinutes: 15
        },
        
        // Notifications defaults
        notifications: {
            defaultPriority: "Norm√°lna",
            defaultFormatting: "Markdown",
            defaultSource: "Automatick√°",
            maxRetries: 3,
            retryDelays: [60000, 300000, 900000], // 1min, 5min, 15min
            
            priorities: ["N√≠zka", "Norm√°lna", "Vysok√°", "Urgentn√©"],
            statuses: ["ƒåak√°", "Odosielanie", "Odoslan√©", "Zlyhalo", "Zru≈°en√©", "Vypr≈°an√©"],
            types: ["Doch√°dzka", "Z√°znam pr√°c", "Kniha j√°zd", "ToDo", "Syst√©mov√°", "Manu√°lna"],
            addressees: ["Zamestnanec", "Skupina", "T√©ma", "Klient", "Partner", "Z√°kazka"]
        }
    };
    
    // ==============================================
    // PRIVATE FUNCTIONS
    // ==============================================
    
    /**
     * Deep merge dvoch objektov
     */
    function deepMerge(target, source) {
        if (!source) return target;
        
        for (var key in source) {
            if (source.hasOwnProperty(key)) {
                if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
                    target[key] = target[key] || {};
                    deepMerge(target[key], source[key]);
                } else {
                    target[key] = source[key];
                }
            }
        }
        return target;
    }
    
    /**
     * Z√≠ska konfigur√°ciu pre modul
     */
    function getModuleConfig(moduleName) {
        // Check cache
        if (configCache[moduleName]) {
            return configCache[moduleName];
        }
        
        // Build config
        var config = {
            system: SYSTEM,
            libraries: LIBRARIES,
            fieldMappings: FIELD_MAPPINGS,
            formats: FORMATS
        };
        
        // Add module defaults
        if (MODULE_DEFAULTS[moduleName]) {
            config[moduleName] = deepMerge({}, MODULE_DEFAULTS[moduleName]);
        }
        
        // Apply overrides
        if (overrides[moduleName]) {
            deepMerge(config, overrides[moduleName]);
        }
        
        // Cache and return
        configCache[moduleName] = config;
        return config;
    }
    
    /**
     * Inicializ√°cia konfigur√°cie
     */
    function initialize() {
        if (initialized) return;
        
        // Load any saved overrides from settings
        try {
            var settingsLib = libByName(LIBRARIES.core.settings);
            if (settingsLib) {
                var entries = settingsLib.entries();
                if (entries && entries.length > 0) {
                    var savedOverrides = entries[0].field("ConfigOverrides");
                    if (savedOverrides) {
                        overrides = JSON.parse(savedOverrides);
                    }
                }
            }
        } catch (e) {
            // Settings not available yet
        }
        
        initialized = true;
    }
    
    // ==============================================
    // PUBLIC API
    // ==============================================
    
    return {
        // Version
        version: SYSTEM.version,
        
        // Initialize
        init: initialize,
        
        // Get configuration
        getConfig: function(moduleName) {
            initialize();
            return moduleName ? getModuleConfig(moduleName) : {
                system: SYSTEM,
                libraries: LIBRARIES,
                fieldMappings: FIELD_MAPPINGS,
                formats: FORMATS
            };
        },
        
        // Get specific parts
        getLibraries: function() {
            initialize();
            return deepMerge({}, LIBRARIES);
        },
        
        getFieldMappings: function(entity) {
            initialize();
            return entity ? FIELD_MAPPINGS[entity] : deepMerge({}, FIELD_MAPPINGS);
        },
        
        getFormats: function() {
            initialize();
            return deepMerge({}, FORMATS);
        },
        
        // Override configuration
        override: function(moduleName, config) {
            if (!moduleName || !config) return false;
            
            overrides[moduleName] = overrides[moduleName] || {};
            deepMerge(overrides[moduleName], config);
            
            // Clear cache
            delete configCache[moduleName];
            
            return true;
        },
        
        // Reset overrides
        resetOverrides: function(moduleName) {
            if (moduleName) {
                delete overrides[moduleName];
                delete configCache[moduleName];
            } else {
                overrides = {};
                configCache = {};
            }
        },
        
        // Save overrides
        saveOverrides: function() {
            try {
                var settingsLib = libByName(LIBRARIES.core.settings);
                if (settingsLib) {
                    var entries = settingsLib.entries();
                    if (entries && entries.length > 0) {
                        entries[0].set("ConfigOverrides", JSON.stringify(overrides));
                        return true;
                    }
                }
            } catch (e) {
                // Error saving
            }
            return false;
        },
        
        // Backward compatibility helpers
        getLibraryName: function(category, library) {
            initialize();
            if (LIBRARIES[category] && LIBRARIES[category][library]) {
                return LIBRARIES[category][library];
            }
            // Fallback - try to find in any category
            for (var cat in LIBRARIES) {
                if (LIBRARIES[cat][library]) {
                    return LIBRARIES[cat][library];
                }
            }
            return null;
        },
        
        getFieldName: function(entity, field) {
            initialize();
            if (FIELD_MAPPINGS[entity] && FIELD_MAPPINGS[entity][field]) {
                return FIELD_MAPPINGS[entity][field];
            }
            return null;
        }
    };
})();

// ==============================================
// GLOBAL EXPORT
// ==============================================

if (typeof module !== 'undefined' && module.exports) {
    module.exports = MementoConfig;
}